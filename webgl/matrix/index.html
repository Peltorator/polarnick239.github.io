<!DOCTYPE html>
<html style="height: 100%">
<head lang="en">
    <meta charset="UTF-8">
    <title>Matrix digital rain</title>
</head>

<script id="matrix_vshader" type="x-shader/x-vertex">
    attribute vec2 aPosition;

    varying vec2 vPosition;

    void main() {
        vPosition = (aPosition + 1.0) / 2.0;
        gl_Position = vec4(aPosition, 0.0, 1.0);
    }
</script>

<script id="matrix_fshader" type="x-shader/x-fragment">
    #line 20
    precision mediump float;

    const vec2 fontsTextureSize = vec2(2048.0, 1024.0);
    const vec2 fontsCount = vec2(16.0, 5.0);
    const vec2 fontsSize = vec2(55.0, 88.0);
    const vec2 fontsStep = vec2(10.0, 24.0);

    uniform sampler2D uFonts;
    uniform vec2 uScreenSize;
    uniform float uTime;

    varying vec2 vPosition;

    vec2 scale(vec2 xy) {
        xy += vec2(0.1, 0.25);
        float xScale = 1.25;
        xy /= xScale;
        return xy;
    }

    float sampleFont(vec2 ij, vec2 xy) {
        xy = scale(xy);
        xy.x = 1.0 - xy.x;
        vec2 fontCorner = (fontsSize + fontsStep) * ij / fontsTextureSize;
        vec2 uv = fontCorner + xy * fontsSize / fontsTextureSize;
        vec4 fontColor = texture2D(uFonts, uv);
        return 1.0 - dot(fontColor.rgb, vec3(1.0)) / 3.0;
    }

    void main() {
        vec2 position = vPosition;
        position.y = 1.0 - position.y;

        float id = mod(uTime * 12.0, fontsCount.x * fontsCount.y);
        vec2 ij = vec2(floor(mod(id, fontsCount.x)), floor(mod(id/fontsCount.x, fontsCount.y)));
        vec2 xy = fract(position * uScreenSize * 4.0 / fontsSize);

        float intensity = sampleFont(ij, xy);
        vec3 background = vec3(0.0, 0.05, 0.0);
        gl_FragColor = vec4(background*(1.0-intensity) + vec3(0.2, 0.9, 0.2)*intensity, 1.0);
    }
</script>

<script src="build/main.js"></script>
<script src="js/glMatrix.js"></script>
<script>
    function start() {
        var canvas = document.getElementById('webgl_canvas');
        matrix.start(canvas,
                document.getElementById('matrix_vshader').text,
                document.getElementById('matrix_fshader').text,
                'fonts.png');
    }
</script>

<body onload="start()" style="margin: 0; padding: 0; height: 100%">
    <canvas id="webgl_canvas" style="width: 100%; height: 100%; display:block;"></canvas>
</body>
</html>