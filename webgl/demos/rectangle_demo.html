<!DOCTYPE html>
<html>
<head>
    <title>PolarNick WebGL</title>

    <script src="../resources/webgl-commons.js" type="text/javascript"></script>

    <script src="../resources/webgl-utils.js" type="text/javascript"></script>
    <script src="../resources/webgl-debug.js" type="text/javascript"></script>
    <script src="../resources/J3DIMath.js"></script>
    <script src="../resources/J3DI.js"></script>

    <script id="vshader" type="x-shader/x-vertex">
        uniform float time;
        uniform vec2 scale_to_square;

        attribute vec2 position;
        attribute vec4 color;

        varying vec4 v_color;

        void main()
        {
            vec2 pos2d = position;
            float scale = (0.75 - sin(time / 500.0) * 0.25) / sqrt(2.0);
            float alpha = time / 500.0;
            float cosA = cos(alpha);
            float sinA = sin(alpha);
            mat2 rotate = mat2(cosA, sinA, -sinA, cosA);

            pos2d = scale * pos2d;
            pos2d = rotate * pos2d;
            pos2d = scale_to_square * pos2d;
            gl_Position = vec4(pos2d, 0.0, 1.0);
            v_color = color;
        }
    </script>

    <script id="fshader" type="x-shader/x-fragment">
        precision mediump float;
        varying vec4 v_color;

        void main()
        {
            gl_FragColor = v_color;
        }
    </script>

    <script>

        var width = 800;
        var height = 600;
        var start_time = new Date().getTime();
        var gl_program = null;
        var indices_buffer = null;

        function init()
        {
            var gl = initWebGL("webgl-canvas");
            if (!gl) {
                alert('No WebGL support!');
                return;
            }
            webgl_commons_gl = gl;
            gl_program = simpleSetup(gl, "vshader", "fshader", [], [ 0, 0, 0, 1 ], 1.0);

            var lightness = 0.6;
            var position = new Float32Array([
                -1, -1,
                -1, +1,
                +1, -1,
                +1, +1]);
            var color = new Float32Array([
                lightness, 0, 0, 1,
                0, lightness, 0, 1,
                0, 0, lightness, 1,
                lightness, lightness, 0, 1]);
            var indices = new Uint8Array([
                0, 1, 2,
                1, 2, 3]);

            indices_buffer = new VertexBufferObject(gl.ELEMENT_ARRAY_BUFFER);
            indices_buffer.bind();
            gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indices, gl.STATIC_DRAW);

            var color_buffer = new VertexBufferObject();
            color_buffer.bind();
            gl.bufferData(gl.ARRAY_BUFFER, color, gl.STATIC_DRAW);
            loc = gl.getAttribLocation(gl_program, 'color');
            gl.enableVertexAttribArray(loc);
            gl.vertexAttribPointer(loc, 4, gl.FLOAT, false, 4*4, 0);
            color_buffer.unbind();

            var position_buffer = new VertexBufferObject();
            position_buffer.bind();
            gl.bufferData(gl.ARRAY_BUFFER, position, gl.STATIC_DRAW);
            loc = gl.getAttribLocation(gl_program, 'position');
            gl.enableVertexAttribArray(loc);
            gl.vertexAttribPointer(loc, 2, gl.FLOAT, false, 2*4, 0);
            position_buffer.unbind();
            return gl;
        }

        function update(gl)
        {
            gl.useProgram(gl_program);
            loc = gl.getUniformLocation(gl_program, 'time');
            delta_time = new Date().getTime() - start_time;
            gl.uniform1f(loc, delta_time);
            scale_width = Math.min(width, height)/width;
            scale_height = Math.min(width, height)/height;
            loc = gl.getUniformLocation(gl_program, 'scale_to_square');
            gl.uniform2f(loc, scale_width, scale_height);
        }

        var requestId;

        function reshape(gl)
        {
            // change the size of the canvas's backing store to match the size it is displayed.
            var canvas = document.getElementById('webgl-canvas');
            if (canvas.clientWidth == canvas.width && canvas.clientHeight == canvas.height)
                return;

            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            width = canvas.width;
            height = canvas.height;

            gl.viewport(0, 0, width, height);
        }

        function drawPicture(gl)
        {
            reshape(gl);
            update(gl);
            gl.enable(gl.DEPTH_TEST);
            gl.clear(gl.COLOR_BUFFER_BIT);
            gl.clear(gl.DEPTH_BUFFER_BIT);
            gl.useProgram(gl_program);
//            indices_buffer.bind();
            gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_BYTE, 0);
//            indices_buffer.unbind();
        }

        function start()
        {
            var c = document.getElementById("webgl-canvas");

//            c = WebGLDebugUtils.makeLostContextSimulatingCanvas(c);
//            c.loseContextInNCalls(1);

            c.addEventListener('webglcontextlost', handleContextLost, false);
            c.addEventListener('webglcontextrestored', handleContextRestored, false);

            var gl = init();
            if (!gl) {
                return;
            }

            framerate = new Framerate("framerate");
            var f = function() {
                drawPicture(gl);
                framerate.snapshot();
                requestId = window.requestAnimFrame(f, c);
            };
            f();

            function handleContextLost(e) {
                e.preventDefault();
                clearLoadingImages();
                if (requestId !== undefined) {
                    window.cancelAnimFrame(requestId);
                    requestId = undefined;
                }
            }

            function handleContextRestored() {
                init();
                f();
            }
        }

    </script>

</head>
    <body onLoad ="start()">
        <canvas id="webgl-canvas" width="800" height="600">
            Your browser does not support canvas element!
        </canvas>
        <div id="framerate">
        </div>
    </body>
</html>