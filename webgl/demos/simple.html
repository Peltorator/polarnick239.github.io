<html>
<head>
    <title>Rotating stripe. PolarNick WebGL.</title>


    <script id="matrix_commons" type="text/javascript">
        var matrix = {};

        matrix.dot = function (a, b) {
            var a00 = a[0], a01 = a[1], a02 = a[2],
                    a10 = a[3], a11 = a[4], a12 = a[5],
                    a20 = a[6], a21 = a[7], a22 = a[8],

                    b00 = b[0], b01 = b[1], b02 = b[2],
                    b10 = b[3], b11 = b[4], b12 = b[5],
                    b20 = b[6], b21 = b[7], b22 = b[8];
            var out = new Float32Array(9);

            out[0] = b00 * a00 + b01 * a10 + b02 * a20;
            out[1] = b00 * a01 + b01 * a11 + b02 * a21;
            out[2] = b00 * a02 + b01 * a12 + b02 * a22;

            out[3] = b10 * a00 + b11 * a10 + b12 * a20;
            out[4] = b10 * a01 + b11 * a11 + b12 * a21;
            out[5] = b10 * a02 + b11 * a12 + b12 * a22;

            out[6] = b20 * a00 + b21 * a10 + b22 * a20;
            out[7] = b20 * a01 + b21 * a11 + b22 * a21;
            out[8] = b20 * a02 + b21 * a12 + b22 * a22;
            return out;
        };

        matrix.transpose = function (a) {
            var out = new Float32Array(9);
            out[0] = a[0];
            out[1] = a[3];
            out[2] = a[6];
            out[3] = a[1];
            out[4] = a[4];
            out[5] = a[7];
            out[6] = a[2];
            out[7] = a[5];
            out[8] = a[8];

            return out;
        };

        matrix.ones = function (n) {
            var out = new Float32Array(n * n);
            out[0] = 1;
            out[1] = 0;
            out[2] = 0;
            out[3] = 0;
            out[4] = 1;
            out[5] = 0;
            out[6] = 0;
            out[7] = 0;
            out[8] = 1;

            return out;
        };

        matrix.rotation_2d = function (alpha) {
            return new Float32Array([
                Math.cos(alpha), -Math.sin(alpha), 0,
                Math.sin(alpha), Math.cos(alpha), 0,
                0, 0, 1]);
        };

        matrix.translation_2d = function (x0, y0) {
            return new Float32Array([
                1, 0, x0,
                0, 1, y0,
                0, 0, 1]);
        };
    </script>


    <script id="gl_commons" type="text/javascript">
        var gl;

        var setupWebGL = function (canvas) {
            var names = ["webgl", "experimental-webgl", "webkit-3d", "moz-webgl"];
            var context = null;
            for (var ii = 0; ii < names.length; ++ii) {
                try {
                    context = canvas.getContext(names[ii], {antialias: true});
                } catch (e) {
                }
                if (context) {
                    gl = context;
                    return true;
                }
            }
            return false;
        };

        function build_shader(shader_code, shader_type) {
            var shader = gl.createShader(shader_type);
            gl.shaderSource(shader, shader_code);
            gl.compileShader(shader);

            var success = gl.getShaderParameter(shader, gl.COMPILE_STATUS);
            if (success) {
                return shader;
            } else {
                console.log('Shader compilation failed!');
                var compilationLog = gl.getShaderInfoLog(shader);
                console.log('Shader compiler log: ' + compilationLog);
                return null;
            }
        }


        function build_program(vertex_code, fragment_code) {
            var gl_program = gl.createProgram();

            var vertex = build_shader(vertex_code, gl.VERTEX_SHADER);
            if (!vertex) {
                return null;
            }
            gl.attachShader(gl_program, vertex);

            if (fragment_code != null) {
                var fragment = build_shader(fragment_code, gl.FRAGMENT_SHADER);
                if (!fragment) {
                    return null;
                }
                gl.attachShader(gl_program, fragment);
            }

            gl.linkProgram(gl_program);

            var success = gl.getProgramParameter(gl_program, gl.LINK_STATUS);
            if (!success) {
                var error_log = gl.getProgramInfoLog(gl_program);
                log("Error in program linking: " + error_log);
                return null;
            }

            gl.detachShader(gl_program, vertex);
            if (fragment_code != null) {
                gl.detachShader(gl_program, fragment);
            }
            return gl_program;
        }


        function VertexBufferObject(target) {
            this.target = target || gl.ARRAY_BUFFER;
            this.handle = gl.createBuffer();
        }

        VertexBufferObject.prototype.bind = function () {
            gl.bindBuffer(this.target, this.handle);
        };

        VertexBufferObject.prototype.unbind = function () {
            gl.bindBuffer(this.target, null);
        };

    </script>


    <script id="js_commons" type="text/javascript">
        /**
         * Framerate object
         *
         * This object keeps track of framerate and displays it as the innerHTML text of the
         * HTML element with the passed id. Once created you call snapshot at the end
         * of every rendering cycle. Every 500ms the framerate is updated in the HTML element.
         *
         * @from J3DI.js - https://code.google.com/p/webgl-code-storage/source/browse/trunk/samples/SpinningBox/resources/J3DI.js?r=2
         */
        Framerate = function (id) {
            this.numFramerates = 10;
            this.framerateUpdateInterval = 500;
            this.id = id;
            this.sourceHtml = document.getElementById(this.id).innerHTML;

            this.renderTime = -1;
            this.framerates = [];
            var self = this;
            var fr = function () {
                self.updateFramerate()
            };
            fr();
            setInterval(fr, this.framerateUpdateInterval);
        };

        Framerate.prototype.updateFramerate = function () {
            var tot = 0;
            for (var i = 0; i < this.framerates.length; ++i)
                tot += this.framerates[i];

            var framerate = -1;
            if (this.framerates.length != 0) {
                framerate = tot / this.framerates.length;
                framerate = Math.round(framerate);
            }
            document.getElementById(this.id).innerHTML = this.sourceHtml.replace('{FPS}', framerate.toString());
        };

        Framerate.prototype.snapshot = function () {
            if (this.renderTime < 0) {
                this.renderTime = new Date().getTime();
            } else {
                var newTime = new Date().getTime();
                var t = newTime - this.renderTime;
                if (t == 0)
                    return;
                var framerate = 1000 / t;
                this.framerates.push(framerate);
                while (this.framerates.length > this.numFramerates)
                    this.framerates.shift();
                this.renderTime = newTime;
            }
        };


        /**
         * Provides requestAnimationFrame in a cross browser way.
         */
        window.requestAnimFrame = (function () {
            return window.requestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.oRequestAnimationFrame ||
                    window.msRequestAnimationFrame ||
                    function (/* function FrameRequestCallback */ callback, /* DOMElement Element */ element) {
                        return window.setTimeout(callback);
                    };
        })();

        window.requestAnimFrameMaxFPS = function (/* function FrameRequestCallback */ callback, /* DOMElement Element */ element) {
            return window.setTimeout(callback, 0);
        };
    </script>


    <script id="vertex_shader" type="x-shader/x-vertex">
        attribute vec2 position;

        uniform mat3 mvpMatrix;

        void main(void) {
            vec3 framePosition = mvpMatrix * vec3(position, 1.0);
            gl_Position = vec4(framePosition.x, framePosition.y, 0.0, framePosition.z);
        }
    </script>


    <script id="fragment_shader" type="x-shader/x-fragment">
        precision highp float;

        uniform vec4 color;

        void main(void) {
            gl_FragColor = color;
        }
    </script>


    <script id="main" type="text/javascript">

        var gl_program;
        var vertex_buf;
        var index_buf;

        var angle = 0;

        function upload_data(vertices, indexes) {
            vertex_buf.bind();
            gl.bufferData(vertex_buf.target, vertices, gl.STATIC_DRAW);
            vertex_buf.unbind();

            index_buf.bind();
            gl.bufferData(index_buf.target, indexes, gl.STATIC_DRAW);
            index_buf.unbind();

            gl.uniform4f(gl_program.colorUniform, 0.4, 0, 0, 1.0);
        }

        function bind_data() {
            vertex_buf.bind();
            gl.vertexAttribPointer(gl_program.positionAttrib, 2, gl.FLOAT, false, 0, 0);
            vertex_buf.unbind();
        }

        function update_canvas_shape(canvas) {
            if (canvas.width != canvas.clientWidth ||
                    canvas.height != canvas.clientHeight) {
                canvas.width = document.documentElement.clientWidth;
                canvas.height = document.documentElement.clientHeight;
                gl.viewport(0, 0, canvas.width, canvas.height);
            }
        }

        var prev_update = null;
        function update() {
            var cur_time = new Date().getTime();
            if (prev_update == null) {
                prev_update = cur_time;
            }

            angle += 0.005 * (cur_time - prev_update);
            var mvpMatrix = matrix.rotation_2d(angle);

            gl.uniformMatrix3fv(gl_program.mvpMatrixUniform, false, mvpMatrix);

            prev_update = cur_time;
        }

        function render_frame(indexes) {
            gl.clearColor(0, 0, 0.1, 1.0);

            gl.enable(gl.DEPTH_TEST);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            index_buf.bind();
            gl.drawElements(gl.TRIANGLES, indexes.length, gl.UNSIGNED_BYTE, 0);
            index_buf.unbind();
        }

        function onready() {
            var canvas = document.getElementById('webgl_canvas');
            if (!setupWebGL(canvas)) {
                alert('No WebGL support!');
                return;
            }
            var framerate = new Framerate("framerate_canvas");


            var vertex_shader_code = document.getElementById("vertex_shader").text;
            var fragment_shader_code = document.getElementById("fragment_shader").text;
            gl_program = build_program(vertex_shader_code, fragment_shader_code);

            gl_program.positionAttrib = gl.getAttribLocation(gl_program, "position");
            gl_program.mvpMatrixUniform = gl.getUniformLocation(gl_program, "mvpMatrix");
            gl_program.colorUniform = gl.getUniformLocation(gl_program, "color");
            gl.enableVertexAttribArray(gl_program.positionAttrib);


            var vertices = new Float32Array([
                -1.0, -0.1,
                -1.0, 0.1,
                1.0, 0.1,
                1.0, -0.1]);
            var indexes = new Uint8Array([0, 1, 2, 0, 2, 3]);

            vertex_buf = new VertexBufferObject();
            index_buf = new VertexBufferObject(gl.ELEMENT_ARRAY_BUFFER);

            gl.useProgram(gl_program);
            upload_data(vertices, indexes);
            bind_data();

            var start_loop = function () {
                update_canvas_shape(canvas);
                update();
                render_frame(indexes);

                framerate.snapshot();
                //replace with "requestAnimFrameMaxFPS(foo, canvas);" to get max FPS
                window.requestAnimFrame(start_loop, canvas);
            };
            start_loop();
        }
    </script>
</head>
<body onload="onready();" style="margin: 0; padding: 0">
    <canvas id="webgl_canvas" style="width: 100%; height: 100%"></canvas>
    <div id="framerate_canvas" style="
            position: fixed;
            top: 0;
            left: 0;
            color: white">
        Framerate: {FPS} FPS<br/>
        This is the simplest demo.
    </div>
</body>
</html>